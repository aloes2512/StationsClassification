---
title: "Classification of Immission Measurements(1)"
author: "Dr. Alf Loeffler"
date: "10/31/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(lubridate)
```

## Classification of Immission Measurements 2000 to 2020 in Baden Wuerttemberg
### longterm trends calculated from recordings at sampling stations###

```{r echo =FALSE}
BW_Rdat_path<- "~/Documents/Luftqualitaet/Daten/BW_Rdat/"
BW_list_tbl <-readRDS(file.path(BW_Rdat_path,"BW_list_tbl.rds"))
Stationsliste <-readRDS(file.path(BW_Rdat_path,"Stationsliste.rds"))
```
### location  of selected sampling stations
20 sampling stations operated by LUBW (Landesanstalt für Umwelt Baden-Wuerttemberg) have been selected for analysis of concentrations of atmospheric constituents.In addition 2 stations operated by the city of Stuttgart "Amt für Umweltschutz".

```{r echo = FALSE}
knitr::kable(Stationsliste)
```

3 sampling stations are located in rural environment,    7 stations located at main streets,   10 sampling urban background immissions. In addition 2 stations operated by  the city of Stuttgart one located downtown on top of a building about 20 m above the street level the second at the office building in urban background. 
An overview of the locations:


![](figs/BW_Uebersichtskarte.png)









```{r stations,echo = FALSE}
station.names<-names(BW_list_tbl)# 22 stations
rural.stations<- c("Alb","Odw","Sws")
trafic.stations <- c("Lbg_Friedr","Stg_Nck","Rt_leder","Stg_Hpt","Stg_Hoh","Stg_Klt")
urban.backgrd.stations<- station.names%>% setdiff(c(rural.stations,trafic.stations))
stations<- list(rural= rural.stations,
                urban= urban.backgrd.stations,
                trafic= trafic.stations)
readRDS( file.path(BW_Rdat_path,"Stationsliste.rds"))
```


As example of NO2 1-h mean values, measured at Stuttgart- Bad Cannstatt at the roadside are shown in the plot "NO2-immissions 20 years". The 1- h means are plotted together with red linear regression line over 20 years:

![Stg_Can](./figs/NO2_trend_20_years_Can.png)

The following should be noted:  
-- the immissions vary annually with maximum in winter month
-- average immissions are reduced with a rate of about $0.4 [μg/m^3]per year$
-- there are long periods without zero 1-h measurements (2016 to 2018) and others reaching zero over longer time periods(2001)
--  outliers indicate a strong variation of the immissions at the location of the sampling instrument

These observations need to be taken into account with interpretation of the data.




```{r echo=FALSE}
comp_detect <- function(df,cmp) {
  exst<- cmp %in% names(df)
  return(exst)
}
BW_mean_NO2<-map_dbl(BW_list_tbl , function(x) ( ifelse (comp_detect(x,"NO2"),
                                                  mean(x$NO2,na.rm=TRUE),NA)))
BW_median_NO2<- map_dbl(BW_list_tbl,function(x) (ifelse (comp_detect (x,"NO2"),
                                                  median(x$NO2,na.rm=TRUE),NA )))
BW_var_NO2 <- map_dbl(BW_list_tbl, function(x) (ifelse (comp_detect (x,"NO2"),
                                                  var(x$NO2,na.rm=TRUE),NA)))
BW_mean_WG <- map_dbl(BW_list_tbl,function(x) (ifelse (comp_detect (x,"WG"),
                                                  mean(x$WG,na.rm=TRUE),NA )))
BW_var_WG <-map_dbl(BW_list_tbl,function(x) (ifelse(comp_detect (x,"WG"),
                                                  var(x$WG,na.rm=TRUE),NA) ))
BW_mean_O3<-map_dbl(BW_list_tbl , function(x) ( ifelse (comp_detect(x,"O3"),
                                                         mean(x$O3,na.rm=TRUE),NA)))
BW_median_O3<- map_dbl(BW_list_tbl,function(x) (ifelse (comp_detect (x,"O3"),
                                                         median(x$O3,na.rm=TRUE),NA )))
BW_var_O3 <- map_dbl(BW_list_tbl, function(x) (ifelse (comp_detect (x,"O3"),
                                                        var(x$O3,na.rm=TRUE),NA)))

BW_statistic <- tibble (Station =  names(BW_list_tbl),
                                NO2_mean=  BW_mean_NO2,
                                NO2_median=BW_median_NO2,
                                NO2_var =  BW_var_NO2,
                                WG_mean =  BW_mean_WG,
                                WG_var =   BW_var_WG,
                                O3_mean =  BW_mean_O3,
                                O3_median= BW_median_O3,
                                O3_var =   BW_var_O3)
```
## Key  immissions data from 23 sampling stations 

Mean values, variance and median of $NO_2$ and $O_3$ concentrations are very different for the 22 stations analyzed: 

```{r echo =FALSE}
BW_statistic%>% arrange(NO2_mean)%>% knitr::kable(digits=1)

```
The table is arranged in ascending order of **mean NO2 immissions measurements** calculated from 1-h measurements  recorded and published by LUBW (Landesanstalt für Umwelt Baden Wuerttemberg). The mean calculated on the 20 year interval of all recorded data.   
--in **rural** environment  immissions are less than  **$10 [μg/m^3]$**.  
--**urban background** immissions range from **$10 [μg/m^3]$ to $30 [μg/m^3]$**.    
--immissions  close to **main traffic** streets are bigger than **$40 [μg/m^3]$**.

## linear trends of immissions at sampling stations


![BW_NO2 trends](./figs/BW_NO2_linear_regression.png)


# Some observations from the trend :
-- average immissions at the three rural stations stay **below $10 [μg/m^3]$**  
-- at the rural stations the mean ** $mean  NO_2 $ ** values are  independent of the time 
-- the regression lines (20 year mean) from stations located in urban background  
   are in between $25 [μg/m^3]$ and  $40 [μg/m^3]$
-- at background stations **rate of reduction of ** $mean  NO_2 $ ** is low** compared  with traffic stations     
-- at main streets (heavy traffic) the **reduction per year** of $mean  NO_2 $ is high   
-- 20-year $mean  NO_2 $ exceeded **limits considered dangerous** to human health **close to main streets**
-- at Stuttgart "Am Neckartor" the highest $mean  NO_2 $ were recorded     
   --- starting in 2003 with annual mean greater $125 [μg/m^3]$ which were reduced to $50 [μg/m^3]$in 2020    
   --- long trend "Am Neckartor"  indicates levels smaller $40 [μg/m^3]$
-- at some stations the *rate of reduction (chg_py)* is  higher than at the station "Am Neckartor"


## rate of immission reductions
```{r echo = FALSE}
ysec<- 60*60*24*365
slp.model <- function (df) {
  cof<-lm(NO2 ~ datetime, data = df)
  slp<-cof$coefficients[2]*ysec
  return(slp)
}
BW_list_tbl$Alb %>% slp.model()
NO2_chg.py<-tibble(Station= names(BW_list_tbl),
                   chg_py=BW_list_tbl%>%map_dbl(~slp.model(.)))%>% arrange(chg_py)
kable(NO2_chg.py,digits =1)

```

The  mean yearly reductions ranges from $-5.1[μg/(m^3*y)]$ at the "Hauptstätter Strasse" and no change at all $0 [μg/(m^3*y)]$ at the rural background  station "Schwarzwald-Süd".


```{r, echo=FALSE}
dat_path<- "~/documents/Luftqualitaet/Daten/BW_Rdat"
load(file.path(dat_path,"BW.RData"))
summary(BW.all_data)
Can_data<-BW.all_data$Stg.Can$Stg.Can.no2 %>% left_join(BW.all_data$Stg.Can$Stg.Can.no)
Can_data<-Can_data%>% left_join(BW.all_data$Stg.Can$Stg.Can.temp)
Can_data<-Can_data%>%left_join(BW.all_data$Stg.Can$Stg.Can.o3)
Can_data_list<-BW.all_data$Stg.Can
Can_comps<-names(BW.all_data$Stg.Can)
length(Can_comps) #8
Can_tbl<- BW.all_data$Stg.Can$Stg.Can.no2%>% dplyr::select(-NO2)
for (i  in 1:8) {
  df <- BW.all_data$Stg.Can[[i]]
  Can_tbl <- left_join(Can_tbl,df, by=c("station", "datetime"))
}
Can_tbl<-Can_tbl%>% mutate(Hzg = as_factor(ifelse(Temp<= 15,"heating", "no_heating")))
comps <- names(Can_tbl)%>%setdiff(c("station","datetime","Hzg"))
Can_tidy<- Can_tbl%>% pivot_longer(cols = all_of(comps),names_to = "comp",values_to =   "value" )
# Plot
Can_tidy %>% na.omit()%>% filter(comp!= "WR"& comp != "WG"& comp != "CO"& comp != "SO2") %>%
  ggplot(aes(x = datetime))+
  geom_smooth(method = "lm",mapping = aes(y= value,col= comp))+
  facet_grid(.~Hzg)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  ggtitle(" 21-Year-Trend(regression)
NO, NO2, O3, Temperature",
          subtitle = "Heating hours Stgt.-Bad Cannstatt")+
  labs(x= "", y = "Values(μg/m3,m/s,°C)")
```
## Effect of Heating on $NO_2, NO, O_3

![](./figs/Trend_NO2.NO.O3.Tem_Can.png)


```{r}
dat_path<- "~/documents/Luftqualitaet/Daten/BW_Rdat"
load(file.path(dat_path,"BW.RData"))
summary(BW.all_data)
Can_data<-BW.all_data$Stg.Can$Stg.Can.no2 %>% left_join(BW.all_data$Stg.Can$Stg.Can.no)
Can_data<-Can_data%>% left_join(BW.all_data$Stg.Can$Stg.Can.temp)
Can_data<-Can_data%>%left_join(BW.all_data$Stg.Can$Stg.Can.o3)
Can_data_list<-BW.all_data$Stg.Can
Can_comps<-names(BW.all_data$Stg.Can)
length(Can_comps) #8
Can_tbl<- BW.all_data$Stg.Can$Stg.Can.no2%>% dplyr::select(-NO2)
for (i  in 1:8) {
  df <- BW.all_data$Stg.Can[[i]]
  Can_tbl <- left_join(Can_tbl,df, by=c("station", "datetime"))
}
Can_tbl<-Can_tbl%>% mutate(Hzg = as_factor(ifelse(Temp<= 15,"heating", "no_heating")))
comps <- names(Can_tbl)%>%setdiff(c("station","datetime","Hzg"))
Can_tidy<- Can_tbl%>% pivot_longer(cols = all_of(comps),names_to = "comp",values_to =   "value" )
# Plot
Can_tidy %>% na.omit()%>% filter(comp!= "WR"& comp != "WG"& comp != "CO"& comp != "SO2") %>%
  ggplot(aes(x = datetime))+
  geom_smooth(method = "lm",mapping = aes(y= value,col= comp))+
  facet_grid(.~Hzg)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  ggtitle(" 21-Year-Trend(regression)
NO, NO2, O3, Temperature",
          subtitle = "Heating hours Stgt.-Bad Cannstatt")+
  labs(x= "", y = "Values(μg/m3,m/s,°C)")
```

## Comparison  with emission data


![](~/documents/Luftqualitaet/Analysen/Abbldg/Emissionen/Emissionen_Trend_BRD.png)

The graph shows the emissions reported to or calculated by the German Umweltbundesamt (UBA). The regression lines the average reduction of total emissions and the contribution of transport and road transport. The main reason for the reduction of transport emissions were improvements were progress with combustion engines and intensive treatment of exhaust gases at power plants and industry. the latter took place mainly 2000 to 2005.

